"0","     ## Chapter 3.2"
"0","####################################################"
"0","## read in monthly flux of stream chemistry for WS2"
"0","# Package ID: knb-lter-hbr.4.17 Cataloging System:https://pasta.edirepository.org."
"0","# Data set title: Hubbard Brook Experimental Forest: Chemistry of Streamwater â Monthly Fluxes, Watershed 2, 1963 - present."
"0","# Data set creator:    - Hubbard Brook Watershed Ecosystem Record (HBWatER) "
"0","# Contact:    -  Hubbard Brook Ecosystem Study  - hbr-im@lternet.edu"
"0","# Stylesheet v2.11 for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@virginia.edu "
"0",""
"0","inUrl1  <- ""https://pasta.lternet.edu/package/data/eml/knb-lter-hbr/4/17/a6aeef15070be913ee2f06f431b9b7a7"" "
"0","infile1 <- tempfile()"
"0","try(download.file(inUrl1,infile1,method=""curl""))"
"1","  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
"
"1","                                 Dload  Upload   Total   Spent    Left  Speed
"
"1","  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0100  153k  100  153k    0     0   120k      0  0:00:01  0:00:01 --:--:--  120k
"
"0","if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method=""auto"")"
"0",""
"0","                   "
"0"," dt5 <-read.csv(infile1,header=F "
"0","          ,skip=1"
"0","            ,sep="",""  "
"0","                ,quot='""' "
"0","        , col.names=c("
"0","                    ""Year"",     "
"0","                    ""Month"",     "
"0","                    ""Year_Month"",     "
"0","                    ""flow_mm"",     "
"0","                    ""Ca_flux"",     "
"0","                    ""Mg_flux"",     "
"0","                    ""K_flux"",     "
"0","                    ""Na_flux"",     "
"0","                    ""Al_Ferron_flux"",     "
"0","                    ""TMAl_flux"",     "
"0","                    ""OMAl_flux"",     "
"0","                    ""Al_ICP_flux"",     "
"0","                    ""NH4_flux"",     "
"0","                    ""SO4_flux"",     "
"0","                    ""NO3_flux"",     "
"0","                    ""Cl_flux"",     "
"0","                    ""PO4_flux"",     "
"0","                    ""DOC_flux"",     "
"0","                    ""TDN_flux"",     "
"0","                    ""DON_flux"",     "
"0","                    ""DIC_flux"",     "
"0","                    ""SiO2_flux"",     "
"0","                    ""Mn_flux"",     "
"0","                    ""Fe_flux"",     "
"0","                    ""F_flux"",     "
"0","                    ""H_flux"",     "
"0","                    ""pH_volwt"",     "
"0","                    ""SpecCond_volwt"",     "
"0","                    ""ANC_volwt""    ), check.names=TRUE)"
"0","               "
"0","unlink(infile1)"
"0","		    "
"0","# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings"
"0","                "
"0","if (class(dt5$Month)!=""factor"") dt5$Month<- as.factor(dt5$Month)"
"0","if (class(dt5$Year_Month)!=""factor"") dt5$Year_Month<- as.factor(dt5$Year_Month)"
"0","if (class(dt5$flow_mm)==""factor"") dt5$flow_mm <-as.numeric(levels(dt5$flow_mm))[as.integer(dt5$flow_mm) ]               "
"0","if (class(dt5$flow_mm)==""character"") dt5$flow_mm <-as.numeric(dt5$flow_mm)"
"0","if (class(dt5$Ca_flux)==""factor"") dt5$Ca_flux <-as.numeric(levels(dt5$Ca_flux))[as.integer(dt5$Ca_flux) ]               "
"0","if (class(dt5$Ca_flux)==""character"") dt5$Ca_flux <-as.numeric(dt5$Ca_flux)"
"0",""
"0","# Convert Missing Values to NA for non-dates"
"0","dt5$flow_mm <- ifelse((trimws(as.character(dt5$flow_mm))==trimws(""-888.88"")),NA,dt5$flow_mm)               "
"0","suppressWarnings(dt5$flow_mm <- ifelse(!is.na(as.numeric(""-888.88"")) & (trimws(as.character(dt5$flow_mm))==as.character(as.numeric(""-888.88""))),NA,dt5$flow_mm))"
"0","dt5$Ca_flux <- ifelse((trimws(as.character(dt5$Ca_flux))==trimws(""-888.88"")),NA,dt5$Ca_flux)               "
"0","suppressWarnings(dt5$Ca_flux <- ifelse(!is.na(as.numeric(""-888.88"")) & (trimws(as.character(dt5$Ca_flux))==as.character(as.numeric(""-888.88""))),NA,dt5$Ca_flux))"
"0",""
"0","# Here is the structure of the input data frame:"
"0","#str(dt5)                            "
"0",""
"0","# conduct data formatting"
"0","#head(dt5)"
"0","dt5$DATE<-paste0(dt5$Year_Month,""-01"") "
"0","dt5$DATE<-ymd(dt5$DATE) # change how R interprets Date to be a date"
"0","# add in water year"
"0","w.year <- as.numeric(format(dt5$DATE, ""%Y""))"
"0","june.july.sept <- as.numeric(format(dt5$DATE, ""%m"")) < 6"
"0","w.year[june.july.sept] <- w.year[june.july.sept] - 1"
"0","dt5$wyear<-w.year"
"0",""
"0","# make sure you are only using complete years for the record"
"0","monchem<-as.data.frame(table( dt5$wyear))"
"0",""
"0","monchem$wys<- paste(monchem$Var1)"
"0","monchem[monchem$Freq<12, ""Use""]<-""incomplete wyear"" # incomplete is less then 12 months"
"0","monchem[is.na(monchem$Use),""Use""]<-""complete"""
"0","#head(monchem, 50)"
"0",""
"0","dt5$Use<-monchem$Use[match(dt5$wyear, monchem$wys)]"
"0",""
"0","dt5.complete<-dt5[dt5$Use==""complete"",]"
"0",""
"0","head(dt5)"
