"pH_volwt",
"SpecCond_volwt"    ), check.names=TRUE)
unlink(infile1)
if (class(dt4$Month)!="factor") dt4$Month<- as.factor(dt4$Month)
if (class(dt4$Year_Month)!="factor") dt4$Year_Month<- as.factor(dt4$Year_Month)
if (class(dt4$precip_mm)=="factor") dt4$precip_mm <-as.numeric(levels(dt4$precip_mm))[as.integer(dt4$precip_mm) ]
if (class(dt4$precip_mm)=="character") dt4$precip_mm <-as.numeric(dt4$precip_mm)
if (class(dt4$Ca_flux)=="factor") dt4$Ca_flux <-as.numeric(levels(dt4$Ca_flux))[as.integer(dt4$Ca_flux) ]
if (class(dt4$Ca_flux)=="character") dt4$Ca_flux <-as.numeric(dt4$Ca_flux)
if (class(dt4$Mg_flux)=="factor") dt4$Mg_flux <-as.numeric(levels(dt4$Mg_flux))[as.integer(dt4$Mg_flux) ]
if (class(dt4$Mg_flux)=="character") dt4$Mg_flux <-as.numeric(dt4$Mg_flux)
if (class(dt4$K_flux)=="factor") dt4$K_flux <-as.numeric(levels(dt4$K_flux))[as.integer(dt4$K_flux) ]
if (class(dt4$K_flux)=="character") dt4$K_flux <-as.numeric(dt4$K_flux)
if (class(dt4$Na_flux)=="factor") dt4$Na_flux <-as.numeric(levels(dt4$Na_flux))[as.integer(dt4$Na_flux) ]
if (class(dt4$Na_flux)=="character") dt4$Na_flux <-as.numeric(dt4$Na_flux)
if (class(dt4$Al_Ferron_flux)=="factor") dt4$Al_Ferron_flux <-as.numeric(levels(dt4$Al_Ferron_flux))[as.integer(dt4$Al_Ferron_flux) ]
if (class(dt4$Al_Ferron_flux)=="character") dt4$Al_Ferron_flux <-as.numeric(dt4$Al_Ferron_flux)
if (class(dt4$TMAl_flux)=="factor") dt4$TMAl_flux <-as.numeric(levels(dt4$TMAl_flux))[as.integer(dt4$TMAl_flux) ]
if (class(dt4$TMAl_flux)=="character") dt4$TMAl_flux <-as.numeric(dt4$TMAl_flux)
if (class(dt4$OMAl_flux)=="factor") dt4$OMAl_flux <-as.numeric(levels(dt4$OMAl_flux))[as.integer(dt4$OMAl_flux) ]
if (class(dt4$OMAl_flux)=="character") dt4$OMAl_flux <-as.numeric(dt4$OMAl_flux)
if (class(dt4$Al_ICP_flux)=="factor") dt4$Al_ICP_flux <-as.numeric(levels(dt4$Al_ICP_flux))[as.integer(dt4$Al_ICP_flux) ]
if (class(dt4$Al_ICP_flux)=="character") dt4$Al_ICP_flux <-as.numeric(dt4$Al_ICP_flux)
if (class(dt4$NH4_flux)=="factor") dt4$NH4_flux <-as.numeric(levels(dt4$NH4_flux))[as.integer(dt4$NH4_flux) ]
if (class(dt4$NH4_flux)=="character") dt4$NH4_flux <-as.numeric(dt4$NH4_flux)
if (class(dt4$SO4_flux)=="factor") dt4$SO4_flux <-as.numeric(levels(dt4$SO4_flux))[as.integer(dt4$SO4_flux) ]
if (class(dt4$SO4_flux)=="character") dt4$SO4_flux <-as.numeric(dt4$SO4_flux)
if (class(dt4$NO3_flux)=="factor") dt4$NO3_flux <-as.numeric(levels(dt4$NO3_flux))[as.integer(dt4$NO3_flux) ]
if (class(dt4$NO3_flux)=="character") dt4$NO3_flux <-as.numeric(dt4$NO3_flux)
if (class(dt4$Cl_flux)=="factor") dt4$Cl_flux <-as.numeric(levels(dt4$Cl_flux))[as.integer(dt4$Cl_flux) ]
if (class(dt4$Cl_flux)=="character") dt4$Cl_flux <-as.numeric(dt4$Cl_flux)
if (class(dt4$PO4_flux)=="factor") dt4$PO4_flux <-as.numeric(levels(dt4$PO4_flux))[as.integer(dt4$PO4_flux) ]
if (class(dt4$PO4_flux)=="character") dt4$PO4_flux <-as.numeric(dt4$PO4_flux)
if (class(dt4$DOC_flux)=="factor") dt4$DOC_flux <-as.numeric(levels(dt4$DOC_flux))[as.integer(dt4$DOC_flux) ]
if (class(dt4$DOC_flux)=="character") dt4$DOC_flux <-as.numeric(dt4$DOC_flux)
if (class(dt4$TDN_flux)=="factor") dt4$TDN_flux <-as.numeric(levels(dt4$TDN_flux))[as.integer(dt4$TDN_flux) ]
if (class(dt4$TDN_flux)=="character") dt4$TDN_flux <-as.numeric(dt4$TDN_flux)
if (class(dt4$DON_flux)=="factor") dt4$DON_flux <-as.numeric(levels(dt4$DON_flux))[as.integer(dt4$DON_flux) ]
if (class(dt4$DON_flux)=="character") dt4$DON_flux <-as.numeric(dt4$DON_flux)
if (class(dt4$SiO2_flux)=="factor") dt4$SiO2_flux <-as.numeric(levels(dt4$SiO2_flux))[as.integer(dt4$SiO2_flux) ]
if (class(dt4$SiO2_flux)=="character") dt4$SiO2_flux <-as.numeric(dt4$SiO2_flux)
if (class(dt4$Mn_flux)=="factor") dt4$Mn_flux <-as.numeric(levels(dt4$Mn_flux))[as.integer(dt4$Mn_flux) ]
if (class(dt4$Mn_flux)=="character") dt4$Mn_flux <-as.numeric(dt4$Mn_flux)
if (class(dt4$Fe_flux)=="factor") dt4$Fe_flux <-as.numeric(levels(dt4$Fe_flux))[as.integer(dt4$Fe_flux) ]
if (class(dt4$Fe_flux)=="character") dt4$Fe_flux <-as.numeric(dt4$Fe_flux)
if (class(dt4$F_flux)=="factor") dt4$F_flux <-as.numeric(levels(dt4$F_flux))[as.integer(dt4$F_flux) ]
if (class(dt4$F_flux)=="character") dt4$F_flux <-as.numeric(dt4$F_flux)
if (class(dt4$H_flux)=="factor") dt4$H_flux <-as.numeric(levels(dt4$H_flux))[as.integer(dt4$H_flux) ]
if (class(dt4$H_flux)=="character") dt4$H_flux <-as.numeric(dt4$H_flux)
if (class(dt4$pH_volwt)=="factor") dt4$pH_volwt <-as.numeric(levels(dt4$pH_volwt))[as.integer(dt4$pH_volwt) ]
if (class(dt4$pH_volwt)=="character") dt4$pH_volwt <-as.numeric(dt4$pH_volwt)
if (class(dt4$SpecCond_volwt)=="factor") dt4$SpecCond_volwt <-as.numeric(levels(dt4$SpecCond_volwt))[as.integer(dt4$SpecCond_volwt) ]
if (class(dt4$SpecCond_volwt)=="character") dt4$SpecCond_volwt <-as.numeric(dt4$SpecCond_volwt)
# Convert Missing Values to NA for non-dates
dt4$precip_mm <- ifelse((trimws(as.character(dt4$precip_mm))==trimws("-888.88")),NA,dt4$precip_mm)
suppressWarnings(dt4$precip_mm <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$precip_mm))==as.character(as.numeric("-888.88"))),NA,dt4$precip_mm))
dt4$Ca_flux <- ifelse((trimws(as.character(dt4$Ca_flux))==trimws("-888.88")),NA,dt4$Ca_flux)
suppressWarnings(dt4$Ca_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Ca_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Ca_flux))
dt4$Mg_flux <- ifelse((trimws(as.character(dt4$Mg_flux))==trimws("-888.88")),NA,dt4$Mg_flux)
suppressWarnings(dt4$Mg_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Mg_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Mg_flux))
dt4$K_flux <- ifelse((trimws(as.character(dt4$K_flux))==trimws("-888.88")),NA,dt4$K_flux)
suppressWarnings(dt4$K_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$K_flux))==as.character(as.numeric("-888.88"))),NA,dt4$K_flux))
dt4$Na_flux <- ifelse((trimws(as.character(dt4$Na_flux))==trimws("-888.88")),NA,dt4$Na_flux)
suppressWarnings(dt4$Na_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Na_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Na_flux))
dt4$Al_Ferron_flux <- ifelse((trimws(as.character(dt4$Al_Ferron_flux))==trimws("-888.88")),NA,dt4$Al_Ferron_flux)
suppressWarnings(dt4$Al_Ferron_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Al_Ferron_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Al_Ferron_flux))
dt4$TMAl_flux <- ifelse((trimws(as.character(dt4$TMAl_flux))==trimws("-888.88")),NA,dt4$TMAl_flux)
suppressWarnings(dt4$TMAl_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$TMAl_flux))==as.character(as.numeric("-888.88"))),NA,dt4$TMAl_flux))
dt4$OMAl_flux <- ifelse((trimws(as.character(dt4$OMAl_flux))==trimws("-888.88")),NA,dt4$OMAl_flux)
suppressWarnings(dt4$OMAl_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$OMAl_flux))==as.character(as.numeric("-888.88"))),NA,dt4$OMAl_flux))
dt4$Al_ICP_flux <- ifelse((trimws(as.character(dt4$Al_ICP_flux))==trimws("-888.88")),NA,dt4$Al_ICP_flux)
suppressWarnings(dt4$Al_ICP_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Al_ICP_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Al_ICP_flux))
dt4$NH4_flux <- ifelse((trimws(as.character(dt4$NH4_flux))==trimws("-888.88")),NA,dt4$NH4_flux)
suppressWarnings(dt4$NH4_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$NH4_flux))==as.character(as.numeric("-888.88"))),NA,dt4$NH4_flux))
dt4$SO4_flux <- ifelse((trimws(as.character(dt4$SO4_flux))==trimws("-888.88")),NA,dt4$SO4_flux)
suppressWarnings(dt4$SO4_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$SO4_flux))==as.character(as.numeric("-888.88"))),NA,dt4$SO4_flux))
dt4$NO3_flux <- ifelse((trimws(as.character(dt4$NO3_flux))==trimws("-888.88")),NA,dt4$NO3_flux)
suppressWarnings(dt4$NO3_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$NO3_flux))==as.character(as.numeric("-888.88"))),NA,dt4$NO3_flux))
dt4$Cl_flux <- ifelse((trimws(as.character(dt4$Cl_flux))==trimws("-888.88")),NA,dt4$Cl_flux)
suppressWarnings(dt4$Cl_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Cl_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Cl_flux))
dt4$PO4_flux <- ifelse((trimws(as.character(dt4$PO4_flux))==trimws("-888.88")),NA,dt4$PO4_flux)
suppressWarnings(dt4$PO4_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$PO4_flux))==as.character(as.numeric("-888.88"))),NA,dt4$PO4_flux))
dt4$DOC_flux <- ifelse((trimws(as.character(dt4$DOC_flux))==trimws("-888.88")),NA,dt4$DOC_flux)
suppressWarnings(dt4$DOC_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$DOC_flux))==as.character(as.numeric("-888.88"))),NA,dt4$DOC_flux))
dt4$TDN_flux <- ifelse((trimws(as.character(dt4$TDN_flux))==trimws("-888.88")),NA,dt4$TDN_flux)
suppressWarnings(dt4$TDN_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$TDN_flux))==as.character(as.numeric("-888.88"))),NA,dt4$TDN_flux))
dt4$DON_flux <- ifelse((trimws(as.character(dt4$DON_flux))==trimws("-888.88")),NA,dt4$DON_flux)
suppressWarnings(dt4$DON_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$DON_flux))==as.character(as.numeric("-888.88"))),NA,dt4$DON_flux))
dt4$SiO2_flux <- ifelse((trimws(as.character(dt4$SiO2_flux))==trimws("-888.88")),NA,dt4$SiO2_flux)
suppressWarnings(dt4$SiO2_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$SiO2_flux))==as.character(as.numeric("-888.88"))),NA,dt4$SiO2_flux))
dt4$Mn_flux <- ifelse((trimws(as.character(dt4$Mn_flux))==trimws("-888.88")),NA,dt4$Mn_flux)
suppressWarnings(dt4$Mn_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Mn_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Mn_flux))
dt4$Fe_flux <- ifelse((trimws(as.character(dt4$Fe_flux))==trimws("-888.88")),NA,dt4$Fe_flux)
suppressWarnings(dt4$Fe_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$Fe_flux))==as.character(as.numeric("-888.88"))),NA,dt4$Fe_flux))
dt4$F_flux <- ifelse((trimws(as.character(dt4$F_flux))==trimws("-888.88")),NA,dt4$F_flux)
suppressWarnings(dt4$F_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$F_flux))==as.character(as.numeric("-888.88"))),NA,dt4$F_flux))
dt4$H_flux <- ifelse((trimws(as.character(dt4$H_flux))==trimws("-888.88")),NA,dt4$H_flux)
suppressWarnings(dt4$H_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$H_flux))==as.character(as.numeric("-888.88"))),NA,dt4$H_flux))
dt4$pH_volwt <- ifelse((trimws(as.character(dt4$pH_volwt))==trimws("-888.88")),NA,dt4$pH_volwt)
suppressWarnings(dt4$pH_volwt <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt4$pH_volwt))==as.character(as.numeric("-888.88"))),NA,dt4$pH_volwt))
dt4$SpecCond_volwt <- ifelse((trimws(as.character(dt4$SpecCond_volwt))==trimws("-888.888")),NA,dt4$SpecCond_volwt)
suppressWarnings(dt4$SpecCond_volwt <- ifelse(!is.na(as.numeric("-888.888")) & (trimws(as.character(dt4$SpecCond_volwt))==as.character(as.numeric("-888.888"))),NA,dt4$SpecCond_volwt))
# conduct data formatting
head(dt4)
dt4$DATE<-paste0(dt4$Year_Month,"-01")
dt4$DATE<-ymd(dt4$DATE) # change how R interprets Date to be a date
# add in water year
w.year <- as.numeric(format(dt4$DATE, "%Y"))
june.july.sept <- as.numeric(format(dt4$DATE, "%m")) < 6
w.year[june.july.sept] <- w.year[june.july.sept] - 1
dt4$wyear<-w.year
head(dt4)
# make sure you are only using complete years for the record
monchem<-as.data.frame(table( dt4$wyear))
monchem$wys<- paste(monchem$Var1)
monchem[monchem$Freq<12, "Use"]<-"incomplete wyear" # incomplete is less then 12 months
monchem[is.na(monchem$Use),"Use"]<-"complete"
head(monchem, 50)
dt4$Use<-monchem$Use[match(dt4$wyear, monchem$wys)]
dt4.complete<-dt4[dt4$Use=="complete",]
# Sum the 12 months to get annual totals
## Ca is in g/ha
annCaWS6<-aggregate(list(Ca.g.ha=dt4.complete$Ca_flux), by=list(wyear=dt4.complete$wyear), FUN="sum")
head(annCaWS6)
# has Ca flux from WS6 changed since the 1960s?
gca1<-ggplot(annCaWS6, aes(x=wyear, y=Ca.g.ha))+geom_point()+geom_line()+
ggtitle("Reference WS6: annual flux of Ca ")+
theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
xlab("Water year (June 1)")+
ylab("Ca (g/ha)")
gca1
inUrl1  <- "https://pasta.lternet.edu/package/data/eml/knb-lter-hbr/16/11/907d535e812f3141942ac7274f268710"
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")
dt5<-read.csv(infile1,header=F
,skip=1
,sep=","
,quot='"'
, col.names=c(
"Year",
"Month",
"Year_Month",
"precip_mm",
"Ca_flux",
"Mg_flux",
"K_flux",
"Na_flux",
"Al_Ferron_flux",
"TMAl_flux",
"OMAl_flux",
"Al_ICP_flux",
"NH4_flux",
"SO4_flux",
"NO3_flux",
"Cl_flux",
"PO4_flux",
"DOC_flux",
"TDN_flux",
"DON_flux",
"SiO2_flux",
"Mn_flux",
"Fe_flux",
"F_flux",
"H_flux",
"pH_volwt",
"SpecCond_volwt"    ), check.names=TRUE)
unlink(infile1)
if (class(dt5$Month)!="factor") dt5$Month<- as.factor(dt5$Month)
if (class(dt5$Year_Month)!="factor") dt5$Year_Month<- as.factor(dt5$Year_Month)
if (class(dt5$precip_mm)=="factor") dt5$precip_mm <-as.numeric(levels(dt5$precip_mm))[as.integer(dt5$precip_mm) ]
if (class(dt5$precip_mm)=="character") dt5$precip_mm <-as.numeric(dt5$precip_mm)
if (class(dt5$Ca_flux)=="factor") dt5$Ca_flux <-as.numeric(levels(dt5$Ca_flux))[as.integer(dt5$Ca_flux) ]
if (class(dt5$Ca_flux)=="character") dt5$Ca_flux <-as.numeric(dt5$Ca_flux)
if (class(dt5$Mg_flux)=="factor") dt5$Mg_flux <-as.numeric(levels(dt5$Mg_flux))[as.integer(dt5$Mg_flux) ]
if (class(dt5$Mg_flux)=="character") dt5$Mg_flux <-as.numeric(dt5$Mg_flux)
if (class(dt5$K_flux)=="factor") dt5$K_flux <-as.numeric(levels(dt5$K_flux))[as.integer(dt5$K_flux) ]
if (class(dt5$K_flux)=="character") dt5$K_flux <-as.numeric(dt5$K_flux)
if (class(dt5$Na_flux)=="factor") dt5$Na_flux <-as.numeric(levels(dt5$Na_flux))[as.integer(dt5$Na_flux) ]
if (class(dt5$Na_flux)=="character") dt5$Na_flux <-as.numeric(dt5$Na_flux)
if (class(dt5$Al_Ferron_flux)=="factor") dt5$Al_Ferron_flux <-as.numeric(levels(dt5$Al_Ferron_flux))[as.integer(dt5$Al_Ferron_flux) ]
if (class(dt5$Al_Ferron_flux)=="character") dt5$Al_Ferron_flux <-as.numeric(dt5$Al_Ferron_flux)
if (class(dt5$TMAl_flux)=="factor") dt5$TMAl_flux <-as.numeric(levels(dt5$TMAl_flux))[as.integer(dt5$TMAl_flux) ]
if (class(dt5$TMAl_flux)=="character") dt5$TMAl_flux <-as.numeric(dt5$TMAl_flux)
if (class(dt5$OMAl_flux)=="factor") dt5$OMAl_flux <-as.numeric(levels(dt5$OMAl_flux))[as.integer(dt5$OMAl_flux) ]
if (class(dt5$OMAl_flux)=="character") dt5$OMAl_flux <-as.numeric(dt5$OMAl_flux)
if (class(dt5$Al_ICP_flux)=="factor") dt5$Al_ICP_flux <-as.numeric(levels(dt5$Al_ICP_flux))[as.integer(dt5$Al_ICP_flux) ]
if (class(dt5$Al_ICP_flux)=="character") dt5$Al_ICP_flux <-as.numeric(dt5$Al_ICP_flux)
if (class(dt5$NH4_flux)=="factor") dt5$NH4_flux <-as.numeric(levels(dt5$NH4_flux))[as.integer(dt5$NH4_flux) ]
if (class(dt5$NH4_flux)=="character") dt5$NH4_flux <-as.numeric(dt5$NH4_flux)
if (class(dt5$SO4_flux)=="factor") dt5$SO4_flux <-as.numeric(levels(dt5$SO4_flux))[as.integer(dt5$SO4_flux) ]
if (class(dt5$SO4_flux)=="character") dt5$SO4_flux <-as.numeric(dt5$SO4_flux)
if (class(dt5$NO3_flux)=="factor") dt5$NO3_flux <-as.numeric(levels(dt5$NO3_flux))[as.integer(dt5$NO3_flux) ]
if (class(dt5$NO3_flux)=="character") dt5$NO3_flux <-as.numeric(dt5$NO3_flux)
if (class(dt5$Cl_flux)=="factor") dt5$Cl_flux <-as.numeric(levels(dt5$Cl_flux))[as.integer(dt5$Cl_flux) ]
if (class(dt5$Cl_flux)=="character") dt5$Cl_flux <-as.numeric(dt5$Cl_flux)
if (class(dt5$PO4_flux)=="factor") dt5$PO4_flux <-as.numeric(levels(dt5$PO4_flux))[as.integer(dt5$PO4_flux) ]
if (class(dt5$PO4_flux)=="character") dt5$PO4_flux <-as.numeric(dt5$PO4_flux)
if (class(dt5$DOC_flux)=="factor") dt5$DOC_flux <-as.numeric(levels(dt5$DOC_flux))[as.integer(dt5$DOC_flux) ]
if (class(dt5$DOC_flux)=="character") dt5$DOC_flux <-as.numeric(dt5$DOC_flux)
if (class(dt5$TDN_flux)=="factor") dt5$TDN_flux <-as.numeric(levels(dt5$TDN_flux))[as.integer(dt5$TDN_flux) ]
if (class(dt5$TDN_flux)=="character") dt5$TDN_flux <-as.numeric(dt5$TDN_flux)
if (class(dt5$DON_flux)=="factor") dt5$DON_flux <-as.numeric(levels(dt5$DON_flux))[as.integer(dt5$DON_flux) ]
if (class(dt5$DON_flux)=="character") dt5$DON_flux <-as.numeric(dt5$DON_flux)
if (class(dt5$SiO2_flux)=="factor") dt5$SiO2_flux <-as.numeric(levels(dt5$SiO2_flux))[as.integer(dt5$SiO2_flux) ]
if (class(dt5$SiO2_flux)=="character") dt5$SiO2_flux <-as.numeric(dt5$SiO2_flux)
if (class(dt5$Mn_flux)=="factor") dt5$Mn_flux <-as.numeric(levels(dt5$Mn_flux))[as.integer(dt5$Mn_flux) ]
if (class(dt5$Mn_flux)=="character") dt5$Mn_flux <-as.numeric(dt5$Mn_flux)
if (class(dt5$Fe_flux)=="factor") dt5$Fe_flux <-as.numeric(levels(dt5$Fe_flux))[as.integer(dt5$Fe_flux) ]
if (class(dt5$Fe_flux)=="character") dt5$Fe_flux <-as.numeric(dt5$Fe_flux)
if (class(dt5$F_flux)=="factor") dt5$F_flux <-as.numeric(levels(dt5$F_flux))[as.integer(dt5$F_flux) ]
if (class(dt5$F_flux)=="character") dt5$F_flux <-as.numeric(dt5$F_flux)
if (class(dt5$H_flux)=="factor") dt5$H_flux <-as.numeric(levels(dt5$H_flux))[as.integer(dt5$H_flux) ]
if (class(dt5$H_flux)=="character") dt5$H_flux <-as.numeric(dt5$H_flux)
if (class(dt5$pH_volwt)=="factor") dt5$pH_volwt <-as.numeric(levels(dt5$pH_volwt))[as.integer(dt5$pH_volwt) ]
if (class(dt5$pH_volwt)=="character") dt5$pH_volwt <-as.numeric(dt5$pH_volwt)
if (class(dt5$SpecCond_volwt)=="factor") dt5$SpecCond_volwt <-as.numeric(levels(dt5$SpecCond_volwt))[as.integer(dt5$SpecCond_volwt) ]
if (class(dt5$SpecCond_volwt)=="character") dt5$SpecCond_volwt <-as.numeric(dt5$SpecCond_volwt)
# Convert Missing Values to NA for non-dates
dt5$precip_mm <- ifelse((trimws(as.character(dt5$precip_mm))==trimws("-888.88")),NA,dt5$precip_mm)
suppressWarnings(dt5$precip_mm <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$precip_mm))==as.character(as.numeric("-888.88"))),NA,dt5$precip_mm))
dt5$Ca_flux <- ifelse((trimws(as.character(dt5$Ca_flux))==trimws("-888.88")),NA,dt5$Ca_flux)
suppressWarnings(dt5$Ca_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Ca_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Ca_flux))
dt5$Mg_flux <- ifelse((trimws(as.character(dt5$Mg_flux))==trimws("-888.88")),NA,dt5$Mg_flux)
suppressWarnings(dt5$Mg_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Mg_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Mg_flux))
dt5$K_flux <- ifelse((trimws(as.character(dt5$K_flux))==trimws("-888.88")),NA,dt5$K_flux)
suppressWarnings(dt5$K_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$K_flux))==as.character(as.numeric("-888.88"))),NA,dt5$K_flux))
dt5$Na_flux <- ifelse((trimws(as.character(dt5$Na_flux))==trimws("-888.88")),NA,dt5$Na_flux)
suppressWarnings(dt5$Na_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Na_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Na_flux))
dt5$Al_Ferron_flux <- ifelse((trimws(as.character(dt5$Al_Ferron_flux))==trimws("-888.88")),NA,dt5$Al_Ferron_flux)
suppressWarnings(dt5$Al_Ferron_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Al_Ferron_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Al_Ferron_flux))
dt5$TMAl_flux <- ifelse((trimws(as.character(dt5$TMAl_flux))==trimws("-888.88")),NA,dt5$TMAl_flux)
suppressWarnings(dt5$TMAl_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$TMAl_flux))==as.character(as.numeric("-888.88"))),NA,dt5$TMAl_flux))
dt5$OMAl_flux <- ifelse((trimws(as.character(dt5$OMAl_flux))==trimws("-888.88")),NA,dt5$OMAl_flux)
suppressWarnings(dt5$OMAl_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$OMAl_flux))==as.character(as.numeric("-888.88"))),NA,dt5$OMAl_flux))
dt5$Al_ICP_flux <- ifelse((trimws(as.character(dt5$Al_ICP_flux))==trimws("-888.88")),NA,dt5$Al_ICP_flux)
suppressWarnings(dt5$Al_ICP_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Al_ICP_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Al_ICP_flux))
dt5$NH4_flux <- ifelse((trimws(as.character(dt5$NH4_flux))==trimws("-888.88")),NA,dt5$NH4_flux)
suppressWarnings(dt5$NH4_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$NH4_flux))==as.character(as.numeric("-888.88"))),NA,dt5$NH4_flux))
dt5$SO4_flux <- ifelse((trimws(as.character(dt5$SO4_flux))==trimws("-888.88")),NA,dt5$SO4_flux)
suppressWarnings(dt5$SO4_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$SO4_flux))==as.character(as.numeric("-888.88"))),NA,dt5$SO4_flux))
dt5$NO3_flux <- ifelse((trimws(as.character(dt5$NO3_flux))==trimws("-888.88")),NA,dt5$NO3_flux)
suppressWarnings(dt5$NO3_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$NO3_flux))==as.character(as.numeric("-888.88"))),NA,dt5$NO3_flux))
dt5$Cl_flux <- ifelse((trimws(as.character(dt5$Cl_flux))==trimws("-888.88")),NA,dt5$Cl_flux)
suppressWarnings(dt5$Cl_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Cl_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Cl_flux))
dt5$PO4_flux <- ifelse((trimws(as.character(dt5$PO4_flux))==trimws("-888.88")),NA,dt5$PO4_flux)
suppressWarnings(dt5$PO4_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$PO4_flux))==as.character(as.numeric("-888.88"))),NA,dt5$PO4_flux))
dt5$DOC_flux <- ifelse((trimws(as.character(dt5$DOC_flux))==trimws("-888.88")),NA,dt5$DOC_flux)
suppressWarnings(dt5$DOC_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$DOC_flux))==as.character(as.numeric("-888.88"))),NA,dt5$DOC_flux))
dt5$TDN_flux <- ifelse((trimws(as.character(dt5$TDN_flux))==trimws("-888.88")),NA,dt5$TDN_flux)
suppressWarnings(dt5$TDN_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$TDN_flux))==as.character(as.numeric("-888.88"))),NA,dt5$TDN_flux))
dt5$DON_flux <- ifelse((trimws(as.character(dt5$DON_flux))==trimws("-888.88")),NA,dt5$DON_flux)
suppressWarnings(dt5$DON_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$DON_flux))==as.character(as.numeric("-888.88"))),NA,dt5$DON_flux))
dt5$SiO2_flux <- ifelse((trimws(as.character(dt5$SiO2_flux))==trimws("-888.88")),NA,dt5$SiO2_flux)
suppressWarnings(dt5$SiO2_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$SiO2_flux))==as.character(as.numeric("-888.88"))),NA,dt5$SiO2_flux))
dt5$Mn_flux <- ifelse((trimws(as.character(dt5$Mn_flux))==trimws("-888.88")),NA,dt5$Mn_flux)
suppressWarnings(dt5$Mn_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Mn_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Mn_flux))
dt5$Fe_flux <- ifelse((trimws(as.character(dt5$Fe_flux))==trimws("-888.88")),NA,dt5$Fe_flux)
suppressWarnings(dt5$Fe_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Fe_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Fe_flux))
dt5$F_flux <- ifelse((trimws(as.character(dt5$F_flux))==trimws("-888.88")),NA,dt5$F_flux)
suppressWarnings(dt5$F_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$F_flux))==as.character(as.numeric("-888.88"))),NA,dt5$F_flux))
dt5$H_flux <- ifelse((trimws(as.character(dt5$H_flux))==trimws("-888.88")),NA,dt5$H_flux)
suppressWarnings(dt5$H_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$H_flux))==as.character(as.numeric("-888.88"))),NA,dt5$H_flux))
dt5$pH_volwt <- ifelse((trimws(as.character(dt5$pH_volwt))==trimws("-888.88")),NA,dt5$pH_volwt)
suppressWarnings(dt5$pH_volwt <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$pH_volwt))==as.character(as.numeric("-888.88"))),NA,dt5$pH_volwt))
dt5$SpecCond_volwt <- ifelse((trimws(as.character(dt5$SpecCond_volwt))==trimws("-888.88")),NA,dt5$SpecCond_volwt)
suppressWarnings(dt5$SpecCond_volwt <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$SpecCond_volwt))==as.character(as.numeric("-888.88"))),NA,dt5$SpecCond_volwt))
# Here is the structure of the input data frame:
str(dt5)
# conduct data formatting
head(dt5)
dt5$DATE<-paste0(dt5$Year_Month,"-01")
dt5$DATE<-ymd(dt5$DATE) # change how R interprets Date to be a date
# add in water year
w.year <- as.numeric(format(dt5$DATE, "%Y"))
june.july.sept <- as.numeric(format(dt5$DATE, "%m")) < 6
w.year[june.july.sept] <- w.year[june.july.sept] - 1
dt5$wyear<-w.year
# make sure you are only using complete years for the record
monchem<-as.data.frame(table( dt5$wyear))
monchem$wys<- paste(monchem$Var1)
monchem[monchem$Freq<12, "Use"]<-"incomplete wyear" # incomplete is less then 12 months
monchem[is.na(monchem$Use),"Use"]<-"complete"
head(monchem, 50)
dt5$Use<-monchem$Use[match(dt5$wyear, monchem$wys)]
dt5.complete<-dt5[dt5$Use=="complete",]
# Sum the 12 months to get annual totals
## Ca is in g/ha
annCaws2<-aggregate(list(Ca.g.ha=dt5.complete$Ca_flux), by=list(wyear=dt5.complete$wyear), FUN="sum")
head(annCaws2)
# Combine WS6 and WS2
annCaws2$WS<-"W2"
annCaWS6$WS<-"W6"
annCa26<-rbind(annCaws2,annCaWS6)
# has Ca flux from WS6 changed since the 1960s?
gca2<-ggplot(annCa26, aes(x=wyear, y=Ca.g.ha, col=WS))+geom_point()+geom_line(size=2)+
ggtitle("Decreasing annual Ca flux in devegetated watershed 2 and reference watershed 6  ")+
theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
xlab("Water year (June 1)")+
ylab("Ca (g/ha)")+
geom_vline(xintercept=1965, linetype="dashed", col="red")+
geom_vline(xintercept=1968, linetype="solid", col="red")+
scale_y_log10()
gca2
pca2<-ggplotly(gca2)
## Chapter 4.1
####################################################
# read in chemistry of precipitation for W6
# Package ID: knb-lter-hbr.20.11 Cataloging System:https://pasta.edirepository.org.
# Data set title: Hubbard Brook Experimental Forest: Chemistry of Precipitation  Monthly Fluxes, Watershed 6, 1964 - present.
inUrl1  <- "https://pasta.lternet.edu/package/data/eml/knb-lter-hbr/20/11/76b46d5bd60e4912406726ec71610d0a"
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")
dt6 <-read.csv(infile1,header=F
,skip=1
,sep=","
,quot='"'
, col.names=c(
"Year",
"Month",
"Year_Month",
"precip_mm",
"Ca_flux",
"Mg_flux",
"K_flux",
"Na_flux",
"Al_Ferron_flux",
"TMAl_flux",
"OMAl_flux",
"Al_ICP_flux",
"NH4_flux",
"SO4_flux",
"NO3_flux",
"Cl_flux",
"PO4_flux",
"DOC_flux",
"TDN_flux",
"DON_flux",
"SiO2_flux",
"Mn_flux",
"Fe_flux",
"F_flux",
"H_flux",
"pH_volwt",
"SpecCond_volwt"    ), check.names=TRUE)
unlink(infile1)
head(dt6)
# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings
if (class(dt6$Month)!="factor") dt6$Month<- as.factor(dt6$Month)
if (class(dt6$Year_Month)!="factor") dt6$Year_Month<- as.factor(dt6$Year_Month)
if (class(dt6$precip_mm)=="factor") dt6$precip_mm <-as.numeric(levels(dt6$precip_mm))[as.integer(dt6$precip_mm) ]
if (class(dt6$precip_mm)=="character") dt6$precip_mm <-as.numeric(dt6$precip_mm)
if (class(dt6$Ca_flux)=="factor") dt6$Ca_flux <-as.numeric(levels(dt6$Ca_flux))[as.integer(dt6$Ca_flux) ]
if (class(dt6$Ca_flux)=="character") dt6$Ca_flux <-as.numeric(dt6$Ca_flux)
# Convert Missing Values to NA for non-dates
dt6$precip_mm <- ifelse((trimws(as.character(dt6$precip_mm))==trimws("-888.88")),NA,dt6$precip_mm)
dt6$Ca_flux <- ifelse((trimws(as.character(dt6$Ca_flux))==trimws("-888.88")),NA,dt6$Ca_flux)
head(dt6)
# add in date
dt6$DATE<-paste0(dt6$Year_Month,"-01")
head(dt6)
dt6$DATE<-ymd(dt6$DATE) # change how R interprets Date to be a date
# add in water year
w.year <- as.numeric(format(dt6$DATE, "%Y"))
june.july.sept <- as.numeric(format(dt6$DATE, "%m")) < 6
w.year[june.july.sept] <- w.year[june.july.sept] - 1
dt6$wyear<-w.year
# make sure you are only using complete years for the record
monchem<-as.data.frame(table( dt6$wyear))
monchem
monchem$wys<- paste(monchem$Var1)
monchem[monchem$Freq<10, "Use"]<-"incomplete wyear" # incomplete is less then 12 months
monchem[is.na(monchem$Use),"Use"]<-"complete"
head(monchem, 50)
dt6$Use<-monchem$Use[match(dt6$wyear, monchem$wys)]
dt6.complete<-dt6[dt6$Use=="complete",]
# calculate annual input of Ca into WS6
head(dt6.complete)
# Sum the 12 months to get annual totals
## Ca is in milligramPerLiter
annCa_precip<-aggregate(list(Ca.g.ha=dt6.complete$Ca_flux, precip_mm=dt6.complete$precip_mm), by=list(wyear=dt6.complete$wyear), FUN="sum")
ginputca1<-ggplot(annCa_precip, aes(x=wyear, y=Ca.g.ha))+geom_point()+geom_line()+
ggtitle("Rain gauge 22? : annual input of Ca ")+xlim(1964,2020)+
theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
xlab("Water year (June 1)")+
ylab("Ca (mg/L)")
ginputca1
head(annstr)
ggplot(annstr, aes(x=Streamflow, y=Precip, col=WS))+geom_point()
ggplot(annstr, aes(x=Streamflow, y=Precip, col=wyear))+geom_point()
# calculate annual input of Ca into WS6
head(dt6.complete)
head(annCa_precip)
annCaWS6
## read in monthly flux of stream chemistry for WS2
# Package ID: knb-lter-hbr.4.17 Cataloging System:https://pasta.edirepository.org.
# Data set title: Hubbard Brook Experimental Forest: Chemistry of Streamwater â Monthly Fluxes, Watershed 2, 1963 - present.
# Data set creator:    - Hubbard Brook Watershed Ecosystem Record (HBWatER)
# Contact:    -  Hubbard Brook Ecosystem Study  - hbr-im@lternet.edu
# Stylesheet v2.11 for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@virginia.edu
inUrl1  <- "https://pasta.lternet.edu/package/data/eml/knb-lter-hbr/4/17/a6aeef15070be913ee2f06f431b9b7a7"
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")
dt5 <-read.csv(infile1,header=F
,skip=1
,sep=","
,quot='"'
, col.names=c(
"Year",
"Month",
"Year_Month",
"flow_mm",
"Ca_flux",
"Mg_flux",
"K_flux",
"Na_flux",
"Al_Ferron_flux",
"TMAl_flux",
"OMAl_flux",
"Al_ICP_flux",
"NH4_flux",
"SO4_flux",
"NO3_flux",
"Cl_flux",
"PO4_flux",
"DOC_flux",
"TDN_flux",
"DON_flux",
"DIC_flux",
"SiO2_flux",
"Mn_flux",
"Fe_flux",
"F_flux",
"H_flux",
"pH_volwt",
"SpecCond_volwt",
"ANC_volwt"    ), check.names=TRUE)
unlink(infile1)
# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings
if (class(dt5$Month)!="factor") dt5$Month<- as.factor(dt5$Month)
if (class(dt5$Year_Month)!="factor") dt5$Year_Month<- as.factor(dt5$Year_Month)
if (class(dt5$flow_mm)=="factor") dt5$flow_mm <-as.numeric(levels(dt5$flow_mm))[as.integer(dt5$flow_mm) ]
if (class(dt5$flow_mm)=="character") dt5$flow_mm <-as.numeric(dt5$flow_mm)
if (class(dt5$Ca_flux)=="factor") dt5$Ca_flux <-as.numeric(levels(dt5$Ca_flux))[as.integer(dt5$Ca_flux) ]
if (class(dt5$Ca_flux)=="character") dt5$Ca_flux <-as.numeric(dt5$Ca_flux)
# Convert Missing Values to NA for non-dates
dt5$flow_mm <- ifelse((trimws(as.character(dt5$flow_mm))==trimws("-888.88")),NA,dt5$flow_mm)
suppressWarnings(dt5$flow_mm <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$flow_mm))==as.character(as.numeric("-888.88"))),NA,dt5$flow_mm))
dt5$Ca_flux <- ifelse((trimws(as.character(dt5$Ca_flux))==trimws("-888.88")),NA,dt5$Ca_flux)
suppressWarnings(dt5$Ca_flux <- ifelse(!is.na(as.numeric("-888.88")) & (trimws(as.character(dt5$Ca_flux))==as.character(as.numeric("-888.88"))),NA,dt5$Ca_flux))
# Here is the structure of the input data frame:
#str(dt5)
# conduct data formatting
#head(dt5)
dt5$DATE<-paste0(dt5$Year_Month,"-01")
dt5$DATE<-ymd(dt5$DATE) # change how R interprets Date to be a date
# add in water year
w.year <- as.numeric(format(dt5$DATE, "%Y"))
june.july.sept <- as.numeric(format(dt5$DATE, "%m")) < 6
w.year[june.july.sept] <- w.year[june.july.sept] - 1
dt5$wyear<-w.year
# make sure you are only using complete years for the record
monchem<-as.data.frame(table( dt5$wyear))
monchem$wys<- paste(monchem$Var1)
monchem[monchem$Freq<12, "Use"]<-"incomplete wyear" # incomplete is less then 12 months
monchem[is.na(monchem$Use),"Use"]<-"complete"
#head(monchem, 50)
dt5$Use<-monchem$Use[match(dt5$wyear, monchem$wys)]
dt5.complete<-dt5[dt5$Use=="complete",]
head(dt5)
# Sum the 12 months to get annual totals
## Ca is in g/ha
annCa_str_WS2<-aggregate(list(Ca.g.ha=dt5.complete$Ca_flux), by=list(wyear=dt5.complete$wyear), FUN="sum")
#head(annCa_str_WS6)
# Combine WS6 and WS2
annCa_str_WS2$Watershed<-"WS2"
annCa_str_WS6$Watershed<-"WS6"
# has Ca flux from WS6 changed since the 1960s?
gca2<-ggplot(annCa26, aes(x=wyear, y=Ca.g.ha, col=WS))+geom_point()+geom_line(size=2)+
ggtitle("Decreasing annual Ca flux in devegetated watershed 2 and reference watershed 6  ")+
theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
xlab("Water year (June 1)")+
ylab("Ca (g/ha)")+
geom_vline(xintercept=1965, linetype="dashed", col="red")+
geom_vline(xintercept=1968, linetype="solid", col="red")+
scale_y_log10()
gca2
head(dt5)
# Sum the 12 months to get annual totals
## Ca is in g/ha
annCa_str_WS2<-aggregate(list(Ca.g.ha=dt5.complete$Ca_flux), by=list(wyear=dt5.complete$wyear), FUN="sum")
# Combine WS6 and WS2
annCa_str_WS2$Watershed<-"WS2"
annCa_str_WS6$Watershed<-"WS6"
annCa_str_WS6$Watershed<-"WS6"
# Combine WS6 and WS2
annCa_str_WS2$Watershed<-"WS2"
head(annCa_str_WS2)
# stream flow volume
mean(annstr$Streamflow)
# stream flow volume
annstr$all_ymean<-mean(annstr$Streamflow)
annstr$diff<-annstr$Streamflow - annstr$all_ymean
sum((annstr$diff^2))
dim(annstr)
sum((annstr$diff^2))
sqrt(sum((annstr$diff^2))   /  (n-1))
str(annstr)
n<- 493
sqrt(sum((annstr$diff^2))   /  (n-1))
